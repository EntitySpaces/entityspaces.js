<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Full entityspaces.js Example</title>
    <script src="../../Libs/jquery-1.7.1.js" type="text/javascript"></script>
    <script src="../../Libs/json2.js" type="text/javascript"></script>
    <script src="../../Libs/knockout-2.0.0.debug.js" type="text/javascript"></script>
    <script src="koGrid/koGrid.debug.js" type="text/javascript"></script>
    <script src="../../Release/entityspaces.XHR.debug.js" type="text/javascript"></script>
    <script src="Generated/Employees.js" type="text/javascript"></script>
    <script src="Generated/Orders.js" type="text/javascript"></script>
    <script src="Generated/OrderDetails.js" type="text/javascript"></script>
    <link href="koGrid/KoGrid.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <table>
        <tr>
            <td colspan="3">
                <h4>Lazy Loading <a href="https://github.com/EntitySpaces/entityspaces.js" target="new">entityspaces.js</a> demonstration. Only the first 10 or so rows have Orders.
            </td>
        </tr>
        <tr>
            <td valign="top" align="left" style="width:1%;">
                Employees:
                <div id="myEmployees" style="max-height: 180px; max-width: 475px; border:1px solid rgb(0, 0, 0);" 
                    data-bind="koGrid:{ 
                        data: employeesCollection, 
                        selectedItem: selectedEmployee,
                        isMultiSelect: false,
                        autogenerateColumns: false,
                        columnDefs: [
                            {field: 'EmployeeID', displayName: 'Employee ID', width: 120}, 
                            {field: 'FirstName', displayName: 'First Name', width: 120}, 
                            {field: 'LastName', displayName: 'Last Name', width: 160}
                        ],
                        displayRowIndex: true }">
                </div>
            </td>
        </tr>
        <tr>
            <td valign="top" align="left" style="width:1%">
                Orders:
                <div id="myOrders" style="max-height: 180px; max-width: 555px; border:1px solid rgb(0,0,0);" 
                    data-bind="koGrid:{ 
                        data: orders, 
                        selectedItem: selectedOrder,
                        isMultiSelect: false,
                        autogenerateColumns: false,
                        columnDefs: [
                            {field: 'OrderID', displayName: 'Order ID', width: 120}, 
                            {field: 'EmployeeID', displayName: 'Employee ID', width: 120},
                            {field: 'CustomerID', displayName: 'Customer ID', width: 120}, 
                            {field: 'Freight', displayName: 'Freight', width: 120}
                        ],
                        displayRowIndex: true }">
                </div>
            </td>
        </tr>
        <tr>
            <td valign="top" align="left" style="width:1%">
                Order Details:
                <div id="myOrderDetails" style="max-height: 180px; max-width: 640px; border:1px solid rgb(0,0,0);" 
                    data-bind="koGrid:{ 
                        data: orderDetails,
                        selectedItem: selectedOrderDetail,
                        isMultiSelect: false,
                        autogenerateColumns: false,
                        columnDefs: [
                            {field: 'OrderID', displayName: 'Order ID', width: 120}, 
                            {field: 'ProductID', displayName: 'Product ID', width: 120}, 
                            {field: 'UnitPrice', displayName: 'Unit Price', width: 120}, 
                            {field: 'Quantity', displayName: 'Quantity', width: 120}, 
                            {field: 'Discount', displayName: 'Discount', width: 100}
                        ],
                        displaySelectionCheckbox: true,
                        displayRowIndex: true }">
                </div>
            </td>
        </tr>
    </table>
</body>

<script type="text/javascript">

    es.dataProvider.baseURL = "http://localhost/esService/esJson.svc/";
    //es.dataProvider.baseURL = "http://www.entityspaces.net/Knockout/Part1/esService/esJson.svc/";

    $(document).ready(function () {

        var vm = function () {
            var self = this;

            this.employeesCollection = new es.objects.EmployeesCollection();

            this.selectedEmployee = ko.observable(new es.objects.Employees());
            this.selectedOrder = ko.observable(new es.objects.Orders());
            this.selectedOrderDetail = ko.observable(new es.objects.OrderDetails());

            this.employeeWasSelected = ko.computed(function () {
                var entity = self.selectedEmployee();
                if (entity !== null) {
                    return entity.OrdersCollectionByEmployeeID();
                } else {
                    return [];
                }
            });

            this.orders = ko.computed(function () {
                var employee = self.selectedEmployee();
                if (employee !== null) {
                    return employee.OrdersCollectionByEmployeeID();
                } else {
                    return [];
                }
            });

            this.orderDetails = ko.computed(function () {
                // here just to make sure we change when a new employee is selected
                var employee = self.selectedEmployee();

                var order = self.selectedOrder();
                if (order !== null && employee !== null) {
                    return order.OrderDetailsCollectionByOrderID();
                } else {
                    return [];
                }
            });
        };

        var vmModel = new vm();

        ko.applyBindings(vmModel);

        // Hit our service ...
        vmModel.employeesCollection.loadAll();
        vmModel.selectedEmployee(vmModel.employeesCollection()[0]);
    });
</script>

</html>